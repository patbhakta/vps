networks:
  vps:
    external: true
  ragflow:
    driver: bridge

services:
  # ===================
  # Tailscale Sidecar
  # ===================
  ragflow-on-vps:
    image: tailscale/tailscale:latest
    hostname: ragflow-on-vps
    ports:
      - "9380:9380" # API
      - "9381:9381" # Admin API
    environment:
      - TS_EXTRA_ARGS=--auth-key file:/run/secrets/tsauthkey
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ${PWD}/tailscale-ragflow/state:/var/lib/tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
    restart: unless-stopped
    secrets:
      - tsauthkey
    networks:
      - vps
      - ragflow

  # ===================
  # RagFlow Application (CPU)
  # ===================
  ragflow:
    container_name: ragflow
    depends_on:
      mysql:
        condition: service_healthy
      es01:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    image: infiniflow/ragflow:v0.23.0
    command:
      - --enable-adminserver
    network_mode: service:ragflow-on-vps
    volumes:
      - ./ragflow-logs:/ragflow/logs
      - ./nginx/ragflow.conf:/etc/nginx/conf.d/ragflow.conf
      - ./nginx/proxy.conf:/etc/nginx/proxy.conf
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./service_conf.yaml.template:/ragflow/conf/service_conf.yaml.template
      - ./entrypoint.sh:/ragflow/entrypoint.sh
    env_file: .env
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ===================
  # Dependencies
  # ===================
  es01:
    image: elasticsearch:8.11.3
    container_name: ragflow-es
    volumes:
      - esdata01:/usr/share/elasticsearch/data
    env_file: .env
    environment:
      - node.name=es01
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-infini_rag_flow}
      - bootstrap.memory_lock=false
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
      - cluster.routing.allocation.disk.watermark.low=5gb
      - cluster.routing.allocation.disk.watermark.high=3gb
      - cluster.routing.allocation.disk.watermark.flood_stage=2gb
    mem_limit: 6442450944
    ulimits:
      memlock:
        soft: -1
        hard: -1
    healthcheck:
      test: [ "CMD-SHELL", "curl http://localhost:9200" ]
      interval: 10s
      timeout: 10s
      retries: 120
    networks:
      - ragflow
    restart: unless-stopped

  mysql:
    image: mysql:8.0.39
    container_name: ragflow-mysql
    env_file: .env
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD:-infini_rag_flow}
    command: --max_connections=1000 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-authentication-plugin=mysql_native_password --tls_version="TLSv1.2,TLSv1.3" --init-file /data/application/init.sql --binlog_expire_logs_seconds=604800
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/data/application/init.sql
    networks:
      - ragflow
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-uroot", "-p${MYSQL_PASSWORD:-infini_rag_flow}" ]
      interval: 10s
      timeout: 10s
      retries: 120
    restart: unless-stopped

  minio:
    image: quay.io/minio/minio:RELEASE.2025-06-13T11-33-47Z
    container_name: ragflow-minio
    command: [ "server", "--console-address", ":9001", "/data" ]
    env_file: .env
    environment:
      - MINIO_ROOT_USER=${MINIO_USER:-rag_flow}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD:-infini_rag_flow}
    volumes:
      - minio_data:/data
    networks:
      - ragflow
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 10s
      retries: 120

  redis:
    image: valkey/valkey:8
    container_name: ragflow-redis
    command: [ "redis-server", "--requirepass", "${REDIS_PASSWORD:-infini_rag_flow}", "--maxmemory", "128mb", "--maxmemory-policy", "allkeys-lru" ]
    env_file: .env
    volumes:
      - redis_data:/data
    networks:
      - ragflow
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-infini_rag_flow}", "ping" ]
      interval: 10s
      timeout: 10s
      retries: 120

secrets:
  tsauthkey:
    file: ~/vps/.config/tsauthkey

volumes:
  esdata01:
  mysql_data:
  minio_data:
  redis_data:
