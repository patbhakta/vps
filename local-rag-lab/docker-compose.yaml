version: '3.8'

services:
  # ===================
  # Database Layer
  # ===================
  neo4j:
    image: neo4j:5.15.0-community
    container_name: local-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc"]
    volumes:
      - ./data/neo4j:/data

  qdrant:
    image: qdrant/qdrant:latest
    container_name: local-qdrant
    ports:
      - "6333:6333"
    volumes:
      - ./data/qdrant:/qdrant/storage

  postgres:
    image: postgres:15-alpine
    container_name: local-postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=kestra
    volumes:
      - ./data/postgres:/var/lib/postgresql/data

  # ===================
  # Orchestration (Kestra)
  # ===================
  kestra:
    image: kestra/kestra:latest
    container_name: local-kestra
    command: server standalone
    ports:
      - "8081:8080" # Mapping to 8081 to avoid common 8080 conflicts
    environment:
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://postgres:5432/kestra
            username: postgres
            password: postgres
    volumes:
      - ./data/kestra:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - postgres

  # ===================
  # Local LLM Engine (Ollama)
  # ===================
  ollama:
    image: ollama/ollama:latest
    container_name: local-ollama
    ports:
      - "11434:11434"
    volumes:
      - ./data/ollama:/root/.ollama
    # Uncomment if you have an NVIDIA GPU for local acceleration
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

    # ===================
    # Gardening (TrustGraph)
    # ===================
  trustgraph:
    image: trustgraph/trustgraph:latest
    container_name: local-trustgraph
    ports:
      - "8888:8888" # Workbench
      - "8000:8000" # API
    environment:
      - NEO4J_URL=bolt://neo4j:7687
      - QDRANT_URL=http://qdrant:6333
      - OLLAMA_HOST=http://ollama:11434
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=password
    depends_on:
      - neo4j
      - qdrant
      - ollama

networks:
  default:
    name: rag-net
    driver: bridge
